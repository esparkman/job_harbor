<!DOCTYPE html>
<html lang="en" class="<%= sq_config.theme == :light ? '' : 'dark' %>">
<head>
  <title><%= @page_title ? "#{@page_title} - Job Harbor" : "Job Harbor" %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= stylesheet_link_tag "job_harbor/application", media: "all" %>
</head>
<body class="min-h-screen">
  <%# === Top Navbar === %>
  <nav class="navbar">
    <%# Logo %>
    <a href="<%= root_path %>" class="flex items-center gap-2 pl-1 text-xl font-bold tracking-tight no-underline" style="color: hsl(var(--foreground));">
      <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: hsl(var(--primary));">
        <circle cx="12" cy="5" r="2.5"/>
        <line x1="12" y1="7.5" x2="12" y2="19"/>
        <path d="M5 12c0-3 3.5-4 7-4s7 1 7 4"/>
        <path d="M4 19c1-2 3.5-3 8-3s7 1 8 3"/>
      </svg>
      Job Harbor
    </a>

    <%# Nav Links %>
    <div class="navbar-section ml-4">
      <%= render JobHarbor::NavLinkComponent.new(
        path: root_path,
        label: "Dashboard",
        icon: "dashboard",
        active: controller_name == "dashboard"
      ) %>
      <%= render JobHarbor::NavLinkComponent.new(
        path: jobs_path,
        label: "Jobs",
        icon: "jobs",
        active: controller_name == "jobs"
      ) %>
      <%= render JobHarbor::NavLinkComponent.new(
        path: queues_path,
        label: "Queues",
        icon: "queues",
        active: controller_name == "queues"
      ) %>
      <%= render JobHarbor::NavLinkComponent.new(
        path: workers_path,
        label: "Workers",
        icon: "workers",
        active: controller_name == "workers",
        badge: nav_counts[:workers]
      ) %>
      <% if sq_config.enable_recurring_tasks %>
        <%= render JobHarbor::NavLinkComponent.new(
          path: recurring_tasks_path,
          label: "Recurring",
          icon: "recurring",
          active: controller_name == "recurring_tasks",
          badge: nav_counts[:recurring_tasks]
        ) %>
      <% end %>
    </div>

    <%# Right side: refresh + theme + back to app %>
    <div class="ml-auto flex items-center gap-2">
      <%= render JobHarbor::RefreshSelectorComponent.new %>
      <%= render JobHarbor::ThemeToggleComponent.new %>
      <a href="<%= return_to_app_path %>" class="btn btn-outline btn-sm" title="<%= return_to_app_label %>">
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        <span class="hidden sm:inline"><%= return_to_app_label %></span>
      </a>
    </div>
  </nav>

  <%# === Page Header === %>
  <div class="max-w-screen-2xl mx-auto px-6 py-6">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold tracking-tight"><%= @page_title || "Dashboard" %></h1>
      <div class="flex items-center gap-2">
        <% if content_for?(:header_actions) %>
          <%= yield :header_actions %>
        <% end %>
      </div>
    </div>

    <%# === Flash Messages === %>
    <% if flash[:notice] %>
      <div class="alert alert-success mb-4">
        <svg class="w-4 h-4 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <%= flash[:notice] %>
      </div>
    <% end %>
    <% if flash[:alert] %>
      <div class="alert alert-error mb-4">
        <svg class="w-4 h-4 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
        <%= flash[:alert] %>
      </div>
    <% end %>

    <%# === Main Content === %>
    <%= yield %>
  </div>

  <%# === Theme Toggle Script === %>
  <script>
    (function() {
      var STORAGE_KEY = 'jh-theme';

      function getStoredTheme() {
        return localStorage.getItem(STORAGE_KEY);
      }

      function setStoredTheme(theme) {
        localStorage.setItem(STORAGE_KEY, theme);
      }

      function applyTheme(theme) {
        if (theme === 'light') {
          document.documentElement.classList.remove('dark');
        } else {
          document.documentElement.classList.add('dark');
        }
      }

      function getCurrentTheme() {
        return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      }

      function toggleTheme() {
        var newTheme = getCurrentTheme() === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
        setStoredTheme(newTheme);
      }

      // Apply stored theme on page load
      var storedTheme = getStoredTheme();
      if (storedTheme) {
        applyTheme(storedTheme);
      }

      // Theme toggle click handler
      document.addEventListener('click', function(e) {
        var toggle = e.target.closest('.sqd-theme-toggle');
        if (toggle) {
          toggleTheme();
        }
      });
    })();
  </script>

  <%# === Auto-Refresh Script === %>
  <script>
    (function() {
      var STORAGE_KEY = 'jh-refresh-interval';
      var refreshTimer = null;
      var currentInterval = 0;

      function getStoredInterval() {
        var stored = localStorage.getItem(STORAGE_KEY);
        if (stored !== null) return parseInt(stored, 10);
        return <%= sq_config.enable_real_time_updates ? sq_config.poll_interval : 0 %>;
      }

      function setStoredInterval(interval) {
        localStorage.setItem(STORAGE_KEY, interval);
      }

      function refreshContent() {
        var url = window.location.href;
        fetch(url, {
          headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(r) { return r.text(); })
        .then(function(html) {
          var parser = new DOMParser();
          var doc = parser.parseFromString(html, 'text/html');
          var newContent = doc.querySelector('[data-refresh-target="content"]');
          var currentContent = document.querySelector('[data-refresh-target="content"]');
          if (newContent && currentContent) {
            currentContent.innerHTML = newContent.innerHTML;
          }
        })
        .catch(function(e) { console.error('JH refresh error:', e); });
      }

      function startPolling(s) {
        stopPolling();
        currentInterval = s;
        if (s > 0) refreshTimer = setInterval(refreshContent, s * 1000);
      }

      function stopPolling() {
        if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
      }

      function init() {
        var sel = document.querySelector('.sqd-refresh-select');
        if (sel) {
          var interval = getStoredInterval();
          sel.value = interval;
          startPolling(interval);
        }
      }

      document.addEventListener('visibilitychange', function() {
        if (document.hidden) stopPolling();
        else if (currentInterval > 0) startPolling(currentInterval);
      });

      document.addEventListener('change', function(e) {
        var sel = e.target.closest('.sqd-refresh-select');
        if (sel) {
          var interval = parseInt(sel.value, 10);
          setStoredInterval(interval);
          startPolling(interval);
        }
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>

  <%# === Per-Page & Filter Selector Script === %>
  <script>
    (function() {
      document.addEventListener('change', function(e) {
        var perPage = e.target.closest('.sqd-per-page-select');
        if (perPage) {
          var url = perPage.value;
          if (url) window.location.href = url;
          return;
        }
        var filter = e.target.closest('.sqd-filter-select');
        if (filter) {
          var url = filter.value;
          if (url) window.location.href = url;
        }
      });
    })();
  </script>

  <%# === Chart Rendering Script === %>
  <script>
    (function() {
      function initChart() {
        var container = document.querySelector('.sqd-chart');
        if (!container) return;
        var canvas = document.getElementById('sqd-job-chart');
        if (!canvas) return;
        var data = JSON.parse(container.dataset.chartData || '{}');
        if (!data.labels || data.labels.length === 0) return;

        var ctx = canvas.getContext('2d');
        var rect = container.getBoundingClientRect();
        canvas.width = rect.width * 2;
        canvas.height = 400;

        var isDark = document.documentElement.classList.contains('dark');
        var gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
        var textColor = isDark ? '#a1a1aa' : '#71717a';

        var colors = { completed: '#22c55e', failed: '#ef4444', enqueued: '#0ea5e9' };

        var allValues = [].concat(data.completed || [], data.failed || [], data.enqueued || []);
        var maxVal = Math.max.apply(null, allValues) || 10;
        maxVal = Math.ceil(maxVal * 1.1);

        var pad = { top: 20, right: 20, bottom: 40, left: 50 };
        var cw = canvas.width - pad.left - pad.right;
        var ch = canvas.height - pad.top - pad.bottom;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 1;
        var gridLines = 5;
        for (var i = 0; i <= gridLines; i++) {
          var y = pad.top + (ch / gridLines) * i;
          ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(canvas.width - pad.right, y); ctx.stroke();
          var val = Math.round(maxVal - (maxVal / gridLines) * i);
          ctx.fillStyle = textColor; ctx.font = '20px ui-sans-serif, sans-serif'; ctx.textAlign = 'right';
          ctx.fillText(val, pad.left - 10, y + 6);
        }

        ctx.textAlign = 'center';
        var step = Math.ceil(data.labels.length / 8);
        for (var i = 0; i < data.labels.length; i += step) {
          var x = pad.left + (cw / (data.labels.length - 1)) * i;
          ctx.fillText(data.labels[i], x, canvas.height - 10);
        }

        function drawLine(series, color) {
          if (!series || series.length === 0) return;
          ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.beginPath();
          for (var i = 0; i < series.length; i++) {
            var x = pad.left + (cw / (series.length - 1)) * i;
            var y = pad.top + ch - (series[i] / maxVal) * ch;
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
          }
          ctx.stroke();
          ctx.fillStyle = color;
          for (var i = 0; i < series.length; i++) {
            var x = pad.left + (cw / (series.length - 1)) * i;
            var y = pad.top + ch - (series[i] / maxVal) * ch;
            ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI * 2); ctx.fill();
          }
        }

        drawLine(data.completed, colors.completed);
        drawLine(data.failed, colors.failed);
        drawLine(data.enqueued, colors.enqueued);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChart);
      } else {
        initChart();
      }

      document.addEventListener('click', function(e) {
        if (e.target.closest('.sqd-theme-toggle')) setTimeout(initChart, 100);
      });
    })();
  </script>
</body>
</html>
