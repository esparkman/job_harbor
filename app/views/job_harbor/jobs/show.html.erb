<% content_for :header_actions do %>
  <div class="flex items-center gap-2">
    <% if @job.can_retry? %>
      <%= button_to "Retry Job", retry_job_path(@job), method: :post, class: "btn btn-default btn-sm" %>
    <% end %>
    <% if @job.can_discard? %>
      <%= button_to "Discard Job", discard_job_path(@job), method: :delete, class: "btn btn-destructive btn-sm",
          data: { confirm: "Are you sure you want to discard this job?" } %>
    <% end %>
    <%= link_to "\u2190 Back to Jobs", jobs_path, class: "btn btn-secondary btn-sm" %>
  </div>
<% end %>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Job Details</h2>
    </div>
    <div class="card-content space-y-1">
      <div class="info-line">
        <span class="info-line-label">Status</span>
        <span class="info-line-separator"></span>
        <span class="info-line-value"><%= render JobHarbor::BadgeComponent.new(status: @job.status) %></span>
      </div>

      <div class="info-line">
        <span class="info-line-label">Job Class</span>
        <span class="info-line-separator"></span>
        <span class="info-line-value"><code class="text-sm font-mono"><%= @job.class_name %></code></span>
      </div>

      <div class="info-line">
        <span class="info-line-label">Queue</span>
        <span class="info-line-separator"></span>
        <span class="info-line-value"><%= link_to @job.queue_name, queue_path(@job.queue_name), class: "link" %></span>
      </div>

      <div class="info-line">
        <span class="info-line-label">Priority</span>
        <span class="info-line-separator"></span>
        <span class="info-line-value"><%= @job.priority || "Default" %></span>
      </div>

      <div class="info-line">
        <span class="info-line-label">Active Job ID</span>
        <span class="info-line-separator"></span>
        <span class="info-line-value"><code class="text-xs font-mono"><%= @job.active_job_id %></code></span>
      </div>

      <% if @job.worker_name %>
        <div class="info-line">
          <span class="info-line-label">Worker</span>
          <span class="info-line-separator"></span>
          <span class="info-line-value"><%= @job.worker_name %></span>
        </div>
      <% end %>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Timing</h2>
    </div>
    <div class="card-content space-y-1">
      <div class="info-line">
        <span class="info-line-label">Created At</span>
        <span class="info-line-separator"></span>
        <span class="info-line-value"><%= @job.created_at.strftime("%Y-%m-%d %H:%M:%S %Z") %></span>
      </div>

      <% if @job.scheduled_at %>
        <div class="info-line">
          <span class="info-line-label">Scheduled At</span>
          <span class="info-line-separator"></span>
          <span class="info-line-value"><%= @job.scheduled_at.strftime("%Y-%m-%d %H:%M:%S %Z") %></span>
        </div>
      <% end %>

      <% if @job.finished_at %>
        <div class="info-line">
          <span class="info-line-label">Finished At</span>
          <span class="info-line-separator"></span>
          <span class="info-line-value"><%= @job.finished_at.strftime("%Y-%m-%d %H:%M:%S %Z") %></span>
        </div>
      <% end %>

      <% if @job.failed_at %>
        <div class="info-line">
          <span class="info-line-label">Failed At</span>
          <span class="info-line-separator"></span>
          <span class="info-line-value"><%= @job.failed_at.strftime("%Y-%m-%d %H:%M:%S %Z") %></span>
        </div>
      <% end %>
    </div>
  </div>
</div>

<div class="card mt-6">
  <div class="card-header">
    <h2 class="card-title">Arguments</h2>
  </div>
  <div class="card-content">
    <pre class="code-block"><%= JSON.pretty_generate(@job.parsed_arguments) rescue @job.arguments %></pre>
  </div>
</div>

<% if @job.status == "failed" %>
  <div class="card mt-6" style="border-top: 4px solid rgb(239 68 68);">
    <div class="card-header">
      <h2 class="card-title" style="color: rgb(239 68 68);">Error Details</h2>
    </div>
    <div class="card-content space-y-3">
      <div class="info-line">
        <span class="info-line-label">Exception Class</span>
        <span class="info-line-separator"></span>
        <span class="info-line-value"><code class="text-sm font-mono"><%= @job.error_class || "Unknown" %></code></span>
      </div>

      <div>
        <div class="text-sm text-muted-foreground mb-1">Error Message</div>
        <div class="text-sm font-medium"><%= @job.error_message || "No error message available" %></div>
      </div>

      <% if @job.error_backtrace.present? %>
        <div>
          <div class="text-sm text-muted-foreground mb-1">Backtrace</div>
          <pre class="code-block" style="max-height: 400px; overflow-y: auto;"><%= @job.error_backtrace %></pre>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
